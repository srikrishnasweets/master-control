<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="shortcut icon" href="/Asset/logo.png" type="image/x-icon">
  <title>TV Section Control</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    :root {
      --bg: #f3f6fb;
      --panel: #ffffff;
      --line: #dbe3ef;
      --ink: #1c2b3a;
      --muted: #6a7a8b;
      --primary: #1e5ec8;
      --primary-soft: #eef4ff;
      --success: #1f7f52;
      --success-soft: #eefbf4;
      --radius: 14px;
      --shadow: 0 10px 24px rgba(15, 35, 58, 0.08);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: "Segoe UI", "Noto Sans", sans-serif;
      color: var(--ink);
      background: linear-gradient(180deg, #f7f9fd 0%, var(--bg) 100%);
    }

    .app {
      min-height: 100dvh;
      margin: 0 auto;
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 10px;
      padding: 10px 12px calc(env(safe-area-inset-bottom, 0px) + 14px);
    }

    .topbar {
      color: var(--primary);
      padding: 14px 16px;
    }

    .topbar h1 {
      margin: 0;
      font-size: clamp(1.05rem, 2vw, 1.35rem);
      letter-spacing: 0.01em;
    }

    .toolbar {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: #234c79;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid #c9d7e8;
      border-radius: 10px;
      background: #f7faff;
      color: #244d7a;
      font-size: 0.85rem;
      font-weight: 700;
      padding: 8px 12px;
      cursor: pointer;
    }

    .btn.primary {
      background: linear-gradient(130deg, #1e5ec8, #164ba3);
      border-color: #164ba3;
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .content {
      display: grid;
      gap: 10px;
      align-content: start;
    }

    .list {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: 0 6px 16px rgba(15, 35, 58, 0.06);
    }

    .clickable {
      cursor: pointer;
      transition: transform 120ms ease, border-color 120ms ease;
    }

    .clickable:hover {
      transform: translateY(-1px);
      border-color: #bfd1e7;
    }

    .card.active-section {
      border-color: #b8deca;
      background: linear-gradient(180deg, #ffffff 0%, #f3fcf7 100%);
      box-shadow: 0 8px 18px rgba(24, 121, 70, 0.12);
    }

    .row-head {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 800;
      color: #1f466f;
      line-height: 1.25;
      font-size: 1rem;
    }

    .row-meta {
      margin-top: 6px;
      color: var(--muted);
      font-size: 0.83rem;
      font-weight: 600;
    }

    .badge {
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      border: 1px solid #b8deca;
      background: var(--success-soft);
      color: var(--success);
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.74rem;
      font-weight: 800;
      letter-spacing: 0.02em;
    }

    .section-tools {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status {
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 50;
      max-width: min(86vw, 420px);
      margin: 0;
      border-radius: 10px;
      border: 1px solid #d3e0f0;
      background: #f6f9ff;
      color: #4f657f;
      padding: 10px 12px;
      font-size: 0.84rem;
      font-weight: 700;
      box-shadow: 0 12px 26px rgba(12, 33, 55, 0.15);
    }

    .status.ok {
      border-color: #bfe4ce;
      background: var(--success-soft);
      color: var(--success);
    }

    .status.error {
      border-color: #efc9c9;
      background: #fff3f3;
      color: #c23e3e;
    }

    .status[hidden] { display: none; }

    .empty {
      margin: 0;
      color: var(--muted);
      font-size: 0.92rem;
      padding: 8px 2px;
    }

    .modal {
      position: fixed;
      inset: 0;
      z-index: 60;
      background: rgba(14, 27, 42, 0.5);
      display: grid;
      place-items: center;
      padding: 14px;
    }

    .modal[hidden] { display: none; }

    .modal-card {
      width: min(460px, 100%);
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 20px 42px rgba(13, 30, 49, 0.3);
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .field {
      display: grid;
      gap: 5px;
    }

    .field label {
      font-size: 0.76rem;
      font-weight: 700;
      color: #4f6783;
      letter-spacing: 0.02em;
    }

    .field input,
    .field select {
      border: 1px solid #c8d6e7;
      border-radius: 9px;
      padding: 8px 10px;
      font: inherit;
      font-size: 0.86rem;
      color: #1c3653;
      background: #fbfdff;
    }

    .form-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 860px) {
      .list {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }
    }

    @media (max-width: 560px) {
      .app {
        padding: 8px 10px calc(env(safe-area-inset-bottom, 0px) + 12px);
      }
      .actions {
        width: 100%;
      }
      .actions .btn {
        flex: 1;
      }
      .list {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .status {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <header class="topbar">
      <h1>TV Section Control</h1>
    </header>

    <section class="toolbar">
      <h2 id="viewTitle" class="title">TV IDs</h2>
      <div class="actions">
        <button id="backBtn" class="btn" type="button" hidden>Back</button>
        <button id="refreshBtn" class="btn" type="button">Refresh</button>
      </div>
    </section>

    <section class="content">
      <div id="list" class="list"></div>
    </section>
  </main>

  <div id="moveSectionModal" class="modal" hidden>
    <div class="modal-card">
      <h3 class="row-head"><i class="bi bi-arrow-left-right"></i><span>Move Section</span></h3>
      <div class="field">
        <label for="moveSectionName">Section</label>
        <input id="moveSectionName" type="text" readonly>
      </div>
      <div class="field">
        <label for="moveSectionTargetTv">Target TV ID</label>
        <select id="moveSectionTargetTv"></select>
      </div>
      <div class="form-actions">
        <button id="confirmMoveSectionBtn" class="btn primary" type="button">Move</button>
        <button id="cancelMoveSectionBtn" class="btn" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <p id="status" class="status" hidden></p>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbwaF9TqH6RS2X0oX-aEua8XK1wFLL-pymmmAOsaEHHz1VHeFtMY6mJIDPo1fNDCa6-C/exec";
    const LAST_TV_KEY = "tvControlSelectedTv";

    const viewTitleEl = document.getElementById("viewTitle");
    const listEl = document.getElementById("list");
    const backBtnEl = document.getElementById("backBtn");
    const refreshBtnEl = document.getElementById("refreshBtn");
    const statusEl = document.getElementById("status");
    const moveSectionModalEl = document.getElementById("moveSectionModal");
    const moveSectionNameEl = document.getElementById("moveSectionName");
    const moveSectionTargetTvEl = document.getElementById("moveSectionTargetTv");
    const confirmMoveSectionBtnEl = document.getElementById("confirmMoveSectionBtn");
    const cancelMoveSectionBtnEl = document.getElementById("cancelMoveSectionBtn");

    let tvMap = new Map();
    let selectedTvId = "";
    let currentView = "tv";
    let pending = false;
    let statusTimer = null;
    let movingSectionName = "";

    function normalizeTvId(value) {
      const text = String(value ?? "").trim();
      if (!text) return "";
      if (/^\d+$/.test(text)) return String(Number(text));
      return text;
    }

    function normalizeKey(value) {
      return String(value ?? "").toLowerCase().replace(/[^a-z0-9]/g, "");
    }

    function isTrueLike(value) {
      const v = String(value ?? "").trim().toLowerCase();
      return v === "true" || v === "1" || v === "yes" || v === "y";
    }

    function getValue(row, aliases) {
      if (!row || typeof row !== "object") return "";
      const wanted = aliases.map(normalizeKey);
      const found = Object.keys(row).find((key) => wanted.includes(normalizeKey(key)));
      return found ? row[found] : "";
    }

    function getTvId(row) { return normalizeTvId(getValue(row, ["tv", "tvid", "tv id", "tv_id"])); }
    function getSection(row) { return String(getValue(row, ["section", "group"]) || "").trim(); }
    function isScreenTrue(row) { return isTrueLike(getValue(row, ["screen"])); }

    function setPending(isPending) {
      pending = isPending;
      refreshBtnEl.disabled = isPending;
      backBtnEl.disabled = isPending;
      confirmMoveSectionBtnEl.disabled = isPending;
      cancelMoveSectionBtnEl.disabled = isPending;
    }

    function setStatus(message, tone) {
      if (statusTimer) {
        window.clearTimeout(statusTimer);
        statusTimer = null;
      }
      const text = String(message || "").trim();
      if (!text) {
        statusEl.hidden = true;
        statusEl.textContent = "";
        statusEl.classList.remove("ok", "error");
        return;
      }
      statusEl.hidden = false;
      statusEl.textContent = text;
      statusEl.classList.remove("ok", "error");
      if (tone === "ok") statusEl.classList.add("ok");
      if (tone === "error") statusEl.classList.add("error");
      if (tone === "ok") {
        statusTimer = window.setTimeout(() => {
          statusEl.hidden = true;
        }, 2200);
      }
    }

    function escapeHtml(value) {
      return String(value ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function setView(view) {
      currentView = view;
      backBtnEl.hidden = view === "tv";
      if (view === "tv") viewTitleEl.textContent = "TV IDs";
      if (view === "section") viewTitleEl.textContent = `Sections - TV ${selectedTvId}`;
    }

    function buildTvMap(rows) {
      const map = new Map();
      rows.forEach((row) => {
        const tvId = getTvId(row);
        if (!tvId) return;
        if (!map.has(tvId)) map.set(tvId, []);
        map.get(tvId).push(row);
      });
      return map;
    }

    function sortedTvEntries() {
      return [...tvMap.entries()].sort((a, b) => {
        const an = Number(a[0]);
        const bn = Number(b[0]);
        if (!Number.isNaN(an) && !Number.isNaN(bn)) return an - bn;
        return a[0].localeCompare(b[0]);
      });
    }

    function sectionsForTv(tvId) {
      const rows = tvMap.get(tvId) || [];
      const map = new Map();
      rows.forEach((row) => {
        const section = getSection(row);
        if (!section) return;
        if (!map.has(section)) map.set(section, { count: 0, active: false });
        const item = map.get(section);
        item.count += 1;
        item.active = item.active || isScreenTrue(row);
      });
      return [...map.entries()].sort((a, b) => a[0].localeCompare(b[0]));
    }

    function currentSectionName(tvId) {
      const sections = sectionsForTv(tvId).filter(([, item]) => item.active).map(([name]) => name);
      return sections[0] || "";
    }

    function setRowScreenLocal(row, enabled) {
      if (!row || typeof row !== "object") return;
      const key = Object.keys(row).find((k) => normalizeKey(k) === "screen");
      if (key) {
        row[key] = enabled ? "true" : "false";
      } else {
        row.screen = enabled ? "true" : "false";
      }
    }

    function applyLocalSectionActivation(tvId, sectionName) {
      const rows = tvMap.get(tvId) || [];
      rows.forEach((row) => {
        const isTargetSection = getSection(row) === sectionName;
        setRowScreenLocal(row, isTargetSection);
      });
    }

    function sectionItemsForTv(tvId, sectionName) {
      const rows = tvMap.get(tvId) || [];
      const filtered = rows.filter((row) => getSection(row) === sectionName);
      const items = new Map();
      filtered.forEach((row) => {
        const master = String(getValue(row, ["master"]) || "").trim();
        const product = String(getValue(row, ["product"]) || "").trim();
        if (!master || !product) return;
        const key = `${master}::${product}`;
        if (!items.has(key)) items.set(key, { master, product });
      });
      return [...items.values()];
    }

    function renderTvView() {
      setView("tv");
      const entries = sortedTvEntries();
      if (!entries.length) {
        listEl.innerHTML = '<p class="empty">No TV IDs found.</p>';
        return;
      }
      listEl.innerHTML = entries.map(([tvId, rows]) => {
        const activeSection = currentSectionName(tvId);
        return `
          <button class="card clickable" type="button" data-tv-id="${escapeHtml(tvId)}">
            <div class="row-head"><i class="bi bi-tv"></i><span>TV ${escapeHtml(tvId)}</span></div>
            <div class="row-meta">${rows.length} rows</div>
            ${activeSection ? `<span class="badge">Live: ${escapeHtml(activeSection)}</span>` : ""}
          </button>
        `;
      }).join("");

      listEl.querySelectorAll("[data-tv-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          selectedTvId = btn.getAttribute("data-tv-id") || "";
          localStorage.setItem(LAST_TV_KEY, selectedTvId);
          renderSectionView();
        });
      });
    }

    function renderSectionView() {
      setView("section");
      const sections = sectionsForTv(selectedTvId);
      if (!sections.length) {
        listEl.innerHTML = '<p class="empty">No sections found for this TV.</p>';
        return;
      }

      listEl.innerHTML = sections.map(([section, info]) => `
        <article class="card ${info.active ? "active-section" : ""}">
          <div class="row-head"><i class="bi bi-grid-1x2"></i><span>${escapeHtml(section)}</span></div>
          <div class="row-meta">${info.count} rows</div>
          ${info.active ? '<span class="badge">Live Section</span>' : ""}
          <div class="section-tools">
            <button class="btn primary" type="button" data-act="activate" data-section="${escapeHtml(section)}" ${info.active ? "disabled" : ""}>
              ${info.active ? "Active" : "Activate"}
            </button>
            <button class="btn" type="button" data-act="move" data-section="${escapeHtml(section)}">Move TV</button>
          </div>
        </article>
      `).join("");

      listEl.querySelectorAll("[data-act]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const action = btn.getAttribute("data-act");
          const section = btn.getAttribute("data-section") || "";
          if (action === "activate") activateSection(section);
          if (action === "move") openMoveSectionModal(section);
        });
      });
    }

    function openMoveSectionModal(sectionName) {
      movingSectionName = sectionName;
      moveSectionNameEl.value = sectionName;
      const options = sortedTvEntries()
        .filter(([tvId]) => tvId !== selectedTvId)
        .map(([tvId]) => `<option value="${escapeHtml(tvId)}">${escapeHtml(tvId)}</option>`)
        .join("");
      if (!options) {
        setStatus("No other TV available to move.", "error");
        movingSectionName = "";
        return;
      }
      moveSectionTargetTvEl.innerHTML = options;
      moveSectionModalEl.hidden = false;
    }

    function closeMoveSectionModal() {
      movingSectionName = "";
      moveSectionNameEl.value = "";
      moveSectionTargetTvEl.innerHTML = "";
      moveSectionModalEl.hidden = true;
    }

    async function callApi(action, payload) {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ action, ...payload })
      });
      const json = await res.json();
      if (!json || json.status !== "success") {
        throw new Error(json && json.message ? json.message : "Action failed");
      }
      return json;
    }

    async function activateSection(sectionName) {
      if (pending || !sectionName) return;
      const tvRows = tvMap.get(selectedTvId) || [];
      const toEnable = tvRows.filter((row) => getSection(row) === sectionName);

      if (!toEnable.length) {
        setStatus("Selected section has no rows.", "error");
        return;
      }

      setPending(true);
      setStatus(`Activating ${sectionName}...`, "");
      try {
        await callApi("setActiveSection", {
          tvId: selectedTvId,
          section: sectionName
        });
        applyLocalSectionActivation(selectedTvId, sectionName);
        renderSectionView();
        setStatus(`Live section set to ${sectionName}`, "ok");
      } catch (error) {
        setStatus(error.message || "Failed to activate section.", "error");
      } finally {
        setPending(false);
      }
    }

    async function moveSectionToTv() {
      if (pending || !movingSectionName) return;
      const targetTvId = normalizeTvId(moveSectionTargetTvEl.value);
      if (!targetTvId) {
        setStatus("Select target TV.", "error");
        return;
      }
      if (targetTvId === selectedTvId) {
        setStatus("Target TV must be different.", "error");
        return;
      }

      const items = sectionItemsForTv(selectedTvId, movingSectionName);
      if (!items.length) {
        setStatus("No rows found in section.", "error");
        return;
      }

      setPending(true);
      setStatus(`Moving ${movingSectionName} to TV ${targetTvId}...`, "");
      try {
        for (let i = 0; i < items.length; i++) {
          const item = items[i];
          await callApi("moveProduct", {
            fromTvId: selectedTvId,
            toTvId: targetTvId,
            master: item.master,
            toMaster: item.master,
            product: item.product
          });
        }

        // Keep one active section rule in destination TV if backend supports it.
        try {
          await callApi("setActiveSection", { tvId: targetTvId, section: movingSectionName });
        } catch (e) {
          // Ignore if endpoint is not deployed yet.
        }

        await loadData(false, true);
        closeMoveSectionModal();
        renderSectionView();
        setStatus(`Moved ${movingSectionName} to TV ${targetTvId}`, "ok");
      } catch (error) {
        setStatus(error.message || "Failed to move section.", "error");
      } finally {
        setPending(false);
      }
    }

    async function loadData(showStatus, preserveSelection) {
      if (pending) return;
      refreshBtnEl.disabled = true;
      if (showStatus !== false) setStatus("Loading data...", "");
      try {
        const previousTvId = selectedTvId;
        const url = `${API_URL}${API_URL.includes("?") ? "&" : "?"}_ts=${Date.now()}`;
        const res = await fetch(url, { cache: "no-store" });
        const json = await res.json();
        const rows = Array.isArray(json?.data) ? json.data : [];
        tvMap = buildTvMap(rows);

        if (preserveSelection && previousTvId && tvMap.has(previousTvId)) {
          selectedTvId = previousTvId;
        } else {
          const savedTv = normalizeTvId(localStorage.getItem(LAST_TV_KEY));
          selectedTvId = savedTv && tvMap.has(savedTv) ? savedTv : "";
        }

        if (currentView === "section" && selectedTvId) {
          renderSectionView();
        } else {
          renderTvView();
        }

        if (showStatus !== false) setStatus(`${tvMap.size} TVs loaded`, "ok");
      } catch (error) {
        tvMap = new Map();
        selectedTvId = "";
        renderTvView();
        setStatus("Unable to load API data.", "error");
      } finally {
        refreshBtnEl.disabled = false;
      }
    }

    backBtnEl.addEventListener("click", () => {
      if (pending) return;
      selectedTvId = "";
      renderTvView();
    });

    refreshBtnEl.addEventListener("click", () => {
      if (pending) return;
      loadData(true, true);
    });

    confirmMoveSectionBtnEl.addEventListener("click", () => {
      moveSectionToTv();
    });

    cancelMoveSectionBtnEl.addEventListener("click", () => {
      if (pending) return;
      closeMoveSectionModal();
    });

    moveSectionModalEl.addEventListener("click", (event) => {
      if (event.target === moveSectionModalEl && !pending) {
        closeMoveSectionModal();
      }
    });

    loadData(true, false);
  </script>
</body>
</html>
